import SConsider, ThirdParty, pdb

Import('*')

buildSettings = {}

opensslbin = ''

def configure():
    global opensslbin
    
    if GetOption('clean') or GetOption('help'):
        return True

    def CheckExecutable(context, executable):
        context.Message('Checking for executable {0}... '.format(executable))
        result = WhereIs(executable)
        context.Result(bool(result))
        return result
    
    env = SConsider.cloneBaseEnv()
    conf = Configure(env, custom_tests = {'CheckExecutable' : CheckExecutable})
    if not conf.CheckCHeader('openssl/ssl.h'):
        print 'Did not find header for '+packagename
        env = conf.Finish()
        return False
    if not conf.CheckLib('ssl'):
        print 'Did not find library for '+packagename
        env = conf.Finish()
        return False
    if not conf.CheckLib('crypto'):
        print 'Did not find library for '+packagename
        env = conf.Finish()
        return False
    opensslbin = conf.CheckExecutable('openssl')
    if not opensslbin:
        print 'Did not find executable for '+packagename
        env = conf.Finish()
        return False
    env = conf.Finish()
    return True

def CheckExecutable(context, executable):
    context.Message('Checking for executable {0}... '.format(executable))
    result = WhereIs(executable)
    context.Result(bool(result))
    return result

if configure():
    buildSettings = {
        packagename : {
            'linkDependencies' : [
                packagename + '.ssl',
                packagename + '.crypto',
            ],
        },
        'ssl' : {
            'public' : {
                'appendUnique'     : {
                    'LIBS'         : ['ssl'],
                },
            },
        },
        'crypto' : {
            'public' : {
                'appendUnique'     : {
                    'LIBS'         : ['crypto'],
                },
            },
        },
        'opensslbin' : {
            'sourceFiles'      : [opensslbin],
            'targetType'       : 'PseudoFile',
        },
        'openSSL' : {
            'targetType'       : 'ProgramApp',
            'runConfig' : {
            },
            'requires' : [
                packagename + '.ssl',
                packagename + '.crypto',
            ],
            'usedTarget'       : packagename + '.opensslbin',
        }
    }

SConsider.createTargets(packagename, buildSettings)
